<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ì„ ìœ„í•œ ìŠ¤ë§ˆíŠ¸ í•™ê¸‰ í¸ì„±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background-color: #f3f4f6;
        }
        .input-card {
            transition: all 0.2s;
        }
        .input-card:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06);
        }
        .class-card {
            min-height: 150px;
            transition: all 0.3s;
        }
        .class-card:hover {
            transform: translateY(-2px);
        }
        .student-tag {
            display: inline-block;
            padding: 4px 10px;
            margin: 3px;
            border-radius: 9999px;
            font-size: 0.9rem;
            background-color: #e0f2fe;
            color: #0369a1;
            border: 1px solid #bae6fd;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .student-tag:hover {
            background-color: #bae6fd;
            transform: scale(1.05);
        }
        /* Highlight Styles */
        .highlight-self {
            background-color: #fde047 !important; /* Yellow */
            border-color: #eab308 !important;
            color: #854d0e !important;
            font-weight: bold;
            transform: scale(1.15);
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.5);
            z-index: 10;
        }
        .highlight-friend {
            background-color: #86efac !important; /* Green */
            border-color: #22c55e !important;
            color: #14532d !important;
            font-weight: bold;
            transform: scale(1.1);
        }
        .highlight-enemy {
            background-color: #fca5a5 !important; /* Red */
            border-color: #ef4444 !important;
            color: #7f1d1d !important;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(239, 68, 68, 0.3);
        }
        .dimmed {
            opacity: 0.25;
            filter: grayscale(100%);
        }
        
        /* Scrollbar */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #f1f1f1; }
        textarea::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Report Toggle Animation */
        #reportDetails {
            transition: max-height 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
        }
        #reportDetails.open {
            max-height: 500px; /* Adjust based on content approximation */
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">ğŸ« ìŠ¤ë§ˆíŠ¸ í•™ê¸‰ í¸ì„± ë„êµ¬</h1>
            <p class="text-slate-600">ì—‘ì…€ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ ì¡°ê±´ì— ë§ëŠ” ìµœì ì˜ ë°˜ í¸ì„±ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Panel: Inputs -->
            <div class="lg:col-span-4 space-y-4">
                
                <!-- Settings -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <label class="block text-sm font-semibold text-slate-700 mb-1">
                        <i class="fas fa-layer-group mr-1 text-blue-500"></i> ìƒì„±í•  í•™ê¸‰ ìˆ˜
                    </label>
                    <input type="number" id="classCount" value="10" min="2" max="50" class="w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="ì˜ˆ: 10">
                </div>

                <!-- Input 1: Must be together -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 input-card">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block font-bold text-green-700">
                            <i class="fas fa-users mr-1"></i> ê¼­ ê°™ì€ ë°˜ (ë‹¨ì§)
                        </label>
                        <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">í•œ ì¤„ì— í•œ íŒ€</span>
                    </div>
                    <textarea id="inputTogether" class="w-full h-32 p-3 text-sm border border-slate-300 rounded-lg focus:outline-none resize-none" placeholder="ì˜ˆì‹œ:&#13;&#10;ê¹€ì² ìˆ˜, ì´í›ˆì´, ë§¹êµ¬&#13;&#10;ìœ ë¦¬, ìˆ˜ì§€"></textarea>
                    <p class="text-xs text-slate-500 mt-1">* ì½¤ë§ˆ(,)ë‚˜ íƒ­(ì—‘ì…€ ë¶™ì—¬ë„£ê¸°)ìœ¼ë¡œ ì´ë¦„ êµ¬ë¶„</p>
                </div>

                <!-- Input 2: Must be separate (All differnt) -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 input-card">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block font-bold text-red-600">
                            <i class="fas fa-bomb mr-1"></i> ì ˆëŒ€ ë‹¤ë¥¸ ë°˜ (ëª¨ë‘ í©ì–´ì§)
                        </label>
                        <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">í•œ ì¤„ ë‚´ ì „ì› ë¶„ë¦¬</span>
                    </div>
                    <textarea id="inputSeparateAll" class="w-full h-32 p-3 text-sm border border-slate-300 rounded-lg focus:outline-none resize-none" placeholder="ì˜ˆì‹œ:&#13;&#10;ì² ìˆ˜, ì˜í¬, ë¯¼ìˆ˜&#13;&#10;Aí•™ìƒ, Bí•™ìƒ"></textarea>
                    <p class="text-xs text-slate-500 mt-1">* ì…ë ¥ëœ ì¤„ì˜ í•™ìƒë“¤ì€ ì„œë¡œ ì ˆëŒ€ ê°™ì€ ë°˜ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                </div>

                <!-- Input 3: Must be separate (One vs List) -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 input-card">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block font-bold text-orange-600">
                            <i class="fas fa-shield-alt mr-1"></i> íŠ¹ì • í•™ìƒ í”¼í•˜ê¸°
                        </label>
                        <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">A // B, C, D</span>
                    </div>
                    <textarea id="inputSeparateTarget" class="w-full h-32 p-3 text-sm border border-slate-300 rounded-lg focus:outline-none resize-none" placeholder="ì˜ˆì‹œ:&#13;&#10;ê¹€ì² ìˆ˜ // ì´ì˜í¬, ë°•ë¯¼ìˆ˜&#13;&#10;A // B, C, D"></textarea>
                    <p class="text-xs text-slate-500 mt-1">* 'ì² ìˆ˜'ëŠ” ë’¤ì˜ í•™ìƒë“¤ê³¼ ë¶„ë¦¬ë©ë‹ˆë‹¤.<br>* 'ì˜í¬'ì™€ 'ë¯¼ìˆ˜' ë¼ë¦¬ë„ ê°€ê¸‰ì  ë¶„ë¦¬ë©ë‹ˆë‹¤.</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button onclick="runAssignment()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-200 flex items-center justify-center">
                        <i class="fas fa-magic mr-2"></i> ë°˜ í¸ì„± ì‹¤í–‰ (ëœë¤)
                    </button>
                    <button onclick="clearInputs()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-4 rounded-xl transition duration-200">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                
                <!-- Error/Status Message -->
                <div id="statusMessage" class="hidden p-3 rounded-lg text-sm font-medium"></div>

            </div>

            <!-- Right Panel: Results -->
            <div class="lg:col-span-8 flex flex-col h-full space-y-4">
                
                <!-- Result Header & Search -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center shrink-0">
                            ğŸ“‹ í¸ì„± ê²°ê³¼
                            <span id="resultCountBadge" class="hidden ml-2 bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-full">0ëª…</span>
                        </h2>
                        <button onclick="copyResults()" class="whitespace-nowrap bg-blue-50 text-blue-600 hover:bg-blue-100 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center">
                            <i class="fas fa-copy mr-1"></i> ê²°ê³¼ ë³µì‚¬
                        </button>
                    </div>
                    
                    <div class="relative w-full md:w-72">
                        <input type="text" id="studentSearch" onkeyup="searchStudent()" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰..." class="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
                    </div>
                </div>

                <!-- Verification Report Section -->
                <div id="verificationSection" class="hidden bg-white rounded-2xl shadow-sm border border-green-200 p-4">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleReport()">
                        <div class="flex items-center gap-2">
                            <div class="bg-green-100 text-green-700 w-8 h-8 rounded-full flex items-center justify-center">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-green-800 text-sm">ìë™ ê²€ì¦ ì™„ë£Œ</h3>
                                <p id="verificationSummary" class="text-xs text-green-600">ëª¨ë“  ì¡°ê±´ì´ ë§Œì¡±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                        <i id="reportToggleIcon" class="fas fa-chevron-down text-green-600 transition-transform"></i>
                    </div>
                    <div id="reportDetails" class="mt-2 text-sm text-slate-600 bg-slate-50 rounded-lg p-2 border border-slate-100">
                        <!-- Verification logs go here -->
                    </div>
                </div>

                <!-- Results Grid -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex-grow min-h-[500px]">
                    <div id="resultGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 auto-rows-min">
                        <div class="col-span-full text-center py-20 text-slate-400">
                            <i class="fas fa-chalkboard text-4xl mb-4"></i>
                            <p>ì™¼ìª½ì˜ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  [ë°˜ í¸ì„± ì‹¤í–‰]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br>ì‹¤í–‰í•  ë•Œë§ˆë‹¤ ê²°ê³¼ê°€ ëœë¤ìœ¼ë¡œ ë‹¬ë¼ì§‘ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic Script -->
    <script>
        // Global Data Structures for Logic
        let groupMap = new Map(); // Student Name -> Group ID
        let groupMembers = new Map(); // Group ID -> [Student Names]
        let groupAdjacency = new Map(); // Group ID -> Set(Group IDs)
        
        // Final Assignment Data for Verification & Interaction
        let finalAssignment = new Map(); // Student Name -> Class Index (0-based)
        let processedGroupIdMap = new Map(); // Student Name -> Final Processed Group ID (for identifying team)
        
        function getGroupId(name, map, members, ids, nextIdObj) {
            name = name.trim();
            if (!name) return null;
            if (map.has(name)) return map.get(name);
            
            const id = nextIdObj.val++;
            map.set(name, id);
            members.set(id, [name]);
            ids.push(id);
            return id;
        }

        function mergeGroups(id1, id2, map, members, ids) {
            if (id1 === id2) return id1;
            const members2 = members.get(id2);
            const members1 = members.get(id1);
            members2.forEach(member => {
                map.set(member, id1);
                members1.push(member);
            });
            members.delete(id2);
            const idx = ids.indexOf(id2);
            if (idx > -1) ids.splice(idx, 1);
            return id1;
        }

        function addConstraint(gid1, gid2, adjMap) {
            if (gid1 === gid2) return;
            if (!adjMap.has(gid1)) adjMap.set(gid1, new Set());
            if (!adjMap.has(gid2)) adjMap.set(gid2, new Set());
            adjMap.get(gid1).add(gid2);
            adjMap.get(gid2).add(gid1);
        }

        function parseNames(text) {
            return text.split(/[\t,]+/).map(s => s.trim()).filter(s => s.length > 0);
        }

        function showStatus(msg, type) {
            const el = document.getElementById('statusMessage');
            el.className = `p-3 rounded-lg text-sm font-medium mb-4 block ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            el.innerHTML = msg;
            if(type === 'error') {
                document.getElementById('verificationSection').classList.add('hidden');
            }
        }

        function clearInputs() {
            if(confirm('ëª¨ë“  ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('inputTogether').value = '';
                document.getElementById('inputSeparateAll').value = '';
                document.getElementById('inputSeparateTarget').value = '';
                document.getElementById('statusMessage').className = "hidden";
                document.getElementById('verificationSection').classList.add('hidden');
                document.getElementById('resultCountBadge').classList.add('hidden');
                document.getElementById('resultGrid').innerHTML = `
                    <div class="col-span-full text-center py-20 text-slate-400">
                        <i class="fas fa-chalkboard text-4xl mb-4"></i>
                        <p>ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>`;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Main Logic ---
        function runAssignment() {
            // Reset Globals
            groupMap = new Map();
            groupMembers = new Map();
            groupAdjacency = new Map();
            processedGroupIdMap = new Map();
            finalAssignment = new Map();
            
            let groupIds = [];
            let nextIdObj = { val: 1 };
            
            const numClasses = parseInt(document.getElementById('classCount').value) || 10;
            const textTogether = document.getElementById('inputTogether').value;
            const textSepAll = document.getElementById('inputSeparateAll').value;
            const textSepTarget = document.getElementById('inputSeparateTarget').value;

            // 1. Grouping
            textTogether.split('\n').forEach(line => {
                const names = parseNames(line);
                if (names.length < 1) return;
                let baseGroupId = getGroupId(names[0], groupMap, groupMembers, groupIds, nextIdObj);
                for (let i = 1; i < names.length; i++) {
                    const targetGroupId = getGroupId(names[i], groupMap, groupMembers, groupIds, nextIdObj);
                    baseGroupId = mergeGroups(baseGroupId, targetGroupId, groupMap, groupMembers, groupIds);
                }
            });

            // 2. Constraints
            // Type 1: All Separate
            textSepAll.split('\n').forEach(line => {
                const names = parseNames(line);
                if (names.length < 2) return;
                for (let i = 0; i < names.length; i++) {
                    for (let j = i + 1; j < names.length; j++) {
                        const g1 = getGroupId(names[i], groupMap, groupMembers, groupIds, nextIdObj);
                        const g2 = getGroupId(names[j], groupMap, groupMembers, groupIds, nextIdObj);
                        if(g1 === g2) {
                            showStatus(`âš ï¸ ëª¨ìˆœ ë°œìƒ: '${names[i]}'ì™€(ê³¼) '${names[j]}'ëŠ” ê°™ì´ ìˆì–´ì•¼ í•˜ë©´ì„œ ë™ì‹œì— ë–¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤.`, 'error');
                            return;
                        }
                        addConstraint(g1, g2, groupAdjacency);
                    }
                }
            });

            // Type 2: Target vs List
            textSepTarget.split('\n').forEach(line => {
                if (!line.includes('//')) return;
                const parts = line.split('//');
                const targetNames = parseNames(parts[0]);
                const avoidNames = parseNames(parts[1]);
                if (targetNames.length === 0 || avoidNames.length === 0) return;

                // Target vs Avoid
                targetNames.forEach(tName => {
                    const tGroup = getGroupId(tName, groupMap, groupMembers, groupIds, nextIdObj);
                    avoidNames.forEach(aName => {
                        const aGroup = getGroupId(aName, groupMap, groupMembers, groupIds, nextIdObj);
                        if(tGroup === aGroup) {
                            showStatus(`âš ï¸ ëª¨ìˆœ ë°œìƒ: '${tName}'ì™€(ê³¼) '${aName}'ëŠ” ê°™ì´ ìˆì–´ì•¼ í•˜ë©´ì„œ ë™ì‹œì— ë–¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤.`, 'error');
                            return;
                        }
                        addConstraint(tGroup, aGroup, groupAdjacency);
                    });
                });

                // Avoid vs Avoid (Constraint: They should also be separated from each other)
                for (let i = 0; i < avoidNames.length; i++) {
                    for (let j = i + 1; j < avoidNames.length; j++) {
                        const g1 = getGroupId(avoidNames[i], groupMap, groupMembers, groupIds, nextIdObj);
                        const g2 = getGroupId(avoidNames[j], groupMap, groupMembers, groupIds, nextIdObj);
                        if (g1 !== g2) {
                            addConstraint(g1, g2, groupAdjacency);
                        }
                    }
                }
            });

            // 3. Solving (Graph Coloring)
            shuffleArray(groupIds);
            groupIds.sort((a, b) => {
                const degA = groupAdjacency.has(a) ? groupAdjacency.get(a).size : 0;
                const degB = groupAdjacency.has(b) ? groupAdjacency.get(b).size : 0;
                return degB - degA;
            });

            const assignment = new Map(); // GroupID -> ClassIdx
            const baseClassIndices = Array.from({length: numClasses}, (_, i) => i);
            let success = true;
            let unassignedGroups = [];

            for (let gid of groupIds) {
                let assigned = false;
                const randomClassIndices = [...baseClassIndices];
                shuffleArray(randomClassIndices);

                for (let c of randomClassIndices) {
                    // Check if safe
                    let safe = true;
                    if (groupAdjacency.has(gid)) {
                        for (let neighborId of groupAdjacency.get(gid)) {
                            if (assignment.has(neighborId) && assignment.get(neighborId) === c) {
                                safe = false;
                                break;
                            }
                        }
                    }
                    if (safe) {
                        assignment.set(gid, c);
                        assigned = true;
                        break;
                    }
                }
                if (!assigned) {
                    success = false;
                    unassignedGroups.push(groupMembers.get(gid).join(', '));
                }
            }

            // 4. Render
            if (!success) {
                const showCount = 5;
                const remaining = unassignedGroups.length - showCount;
                let failMsg = unassignedGroups.slice(0, showCount).join(' / ');
                if (remaining > 0) failMsg += ` ì™¸ ${remaining}íŒ€`;
                showStatus(`âš ï¸ <strong>ë°°ì • ì‹¤íŒ¨</strong><br>ì¡°ê±´ì´ ë„ˆë¬´ ê¹Œë‹¤ë¡œì›Œ ë°˜ ê°œìˆ˜(${numClasses}ê°œ) ë‚´ì— ëª¨ë‘ ë¶„ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ê°ˆ ê³³ ì—†ëŠ” í•™ìƒ(íŒ€):<br><span class="text-xs text-red-600 mt-1 block">${failMsg}</span>`, 'error');
                return;
            }

            // 5. Store Final Data for Verification/Interaction
            let totalStudents = 0;
            assignment.forEach((classIdx, gid) => {
                const members = groupMembers.get(gid);
                members.forEach(m => {
                    finalAssignment.set(m, classIdx);
                    processedGroupIdMap.set(m, gid); // Save group ID for highlighting
                    totalStudents++;
                });
            });

            // Update UI Stats
            document.getElementById('resultCountBadge').classList.remove('hidden');
            document.getElementById('resultCountBadge').innerText = `${totalStudents}ëª… ë°°ì •`;
            showStatus(`âœ… <strong>ë°°ì • ì™„ë£Œ!</strong> (ì´ ${groupIds.length}ê°œ ê·¸ë£¹ ë°°ì¹˜)<br>ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ëœë¤ìœ¼ë¡œ ë‹¤ì‹œ ë°°ì •ë©ë‹ˆë‹¤.`, 'success');

            // Draw Grid
            const grid = document.getElementById('resultGrid');
            grid.innerHTML = '';
            
            // Organize for rendering
            const classes = Array.from({length: numClasses}, () => []);
            finalAssignment.forEach((classIdx, name) => {
                classes[classIdx].push(name);
            });

            classes.forEach((members, idx) => {
                const classNum = idx + 1;
                members.sort(); // Sort alphabetically within class
                
                const card = document.createElement('div');
                card.className = "class-card bg-white border border-slate-200 rounded-xl p-4 shadow-sm flex flex-col relative";
                card.setAttribute('data-class-idx', idx); // For search highlighting
                
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2">
                        <h3 class="font-bold text-lg text-slate-800">${classNum}ë°˜</h3>
                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">${members.length}ëª…</span>
                    </div>
                    <div class="flex-grow student-container">
                        ${members.length > 0 
                            ? members.map(m => `<span class="student-tag" onclick="highlightStudent('${m}')" data-name="${m}">${m}</span>`).join('') 
                            : '<span class="text-slate-400 text-sm">ë°°ì •ëœ í•™ìƒ ì—†ìŒ</span>'}
                    </div>
                `;
                grid.appendChild(card);
            });

            // 6. Run Verification
            verifyResults();
        }

        // --- Feature 1: Verification ---
        function verifyResults() {
            const reportDetails = document.getElementById('reportDetails');
            const section = document.getElementById('verificationSection');
            const summary = document.getElementById('verificationSummary');
            
            section.classList.remove('hidden');
            reportDetails.innerHTML = '';
            
            let totalChecks = 0;
            let passChecks = 0;
            let logs = [];

            function addLog(pass, msg) {
                totalChecks++;
                if (pass) passChecks++;
                const icon = pass ? '<i class="fas fa-check text-green-500 mr-2"></i>' : '<i class="fas fa-times text-red-500 mr-2"></i>';
                const color = pass ? 'text-slate-600' : 'text-red-600 font-bold';
                logs.push(`<div class="mb-1 ${color}">${icon}${msg}</div>`);
            }

            // Verify "Together"
            const textTogether = document.getElementById('inputTogether').value;
            textTogether.split('\n').forEach(line => {
                const names = parseNames(line);
                if (names.length < 2) return;
                
                // Check if all in same class
                const firstClass = finalAssignment.get(names[0]);
                let allSame = true;
                names.forEach(n => {
                    if (finalAssignment.get(n) !== firstClass) allSame = false;
                });
                
                const classNum = firstClass !== undefined ? firstClass + 1 : '?';
                addLog(allSame, `[ë‹¨ì§] ${names.join(', ')} â†’ ëª¨ë‘ ${classNum}ë°˜ ë°°ì •`);
            });

            // Verify "Separate All"
            const textSepAll = document.getElementById('inputSeparateAll').value;
            textSepAll.split('\n').forEach(line => {
                const names = parseNames(line);
                if (names.length < 2) return;
                
                let collision = false;
                let classMap = new Map();
                names.forEach(n => {
                    const c = finalAssignment.get(n);
                    if (classMap.has(c)) collision = true;
                    classMap.set(c, true);
                });

                addLog(!collision, `[ë¶„ë¦¬] ${names.join(', ')} â†’ ëª¨ë‘ ë‹¤ë¥¸ ë°˜ ë°°ì •`);
            });

            // Verify "Separate Target"
            const textSepTarget = document.getElementById('inputSeparateTarget').value;
            textSepTarget.split('\n').forEach(line => {
                if (!line.includes('//')) return;
                const parts = line.split('//');
                const targets = parseNames(parts[0]);
                const avoids = parseNames(parts[1]);
                if (targets.length === 0 || avoids.length === 0) return;

                // Check Target vs Avoids
                let tvsaPass = true;
                targets.forEach(t => {
                    const tClass = finalAssignment.get(t);
                    avoids.forEach(a => {
                        if (finalAssignment.get(a) === tClass) tvsaPass = false;
                    });
                });
                addLog(tvsaPass, `[í”¼í•˜ê¸°] ${targets.join(',')} // ${avoids.join(',')} â†’ ë¶„ë¦¬ë¨`);

                // Check Avoids vs Avoids (Implicit Rule)
                let avsaPass = true;
                let classMap = new Map();
                avoids.forEach(a => {
                    const c = finalAssignment.get(a);
                    if (classMap.has(c)) avsaPass = false;
                    classMap.set(c, true);
                });
                // Only log this if relevant (more than 1 avoid)
                if (avoids.length > 1) {
                    addLog(avsaPass, `[í”¼í•˜ê¸° ê·¸ë£¹ ë‚´ ë¶„ì‚°] ${avoids.join(', ')} â†’ ì„œë¡œ ë‹¤ë¥¸ ë°˜`);
                }
            });

            if (totalChecks === 0) {
                summary.innerText = "ê²€ì¦í•  ë³„ë„ ì¡°ê±´ì´ ì—†ìŠµë‹ˆë‹¤.";
            } else {
                summary.innerText = `ì´ ${totalChecks}ê°œ ì¡°ê±´ ì¤‘ ${passChecks}ê°œ ë§Œì¡± (${passChecks === totalChecks ? '100% ì„±ê³µ' : 'ì‹¤íŒ¨ ì¡´ì¬'})`;
            }
            
            reportDetails.innerHTML = logs.length > 0 ? logs.join('') : '<div class="text-slate-400 italic">ê²€ì¦í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        function toggleReport() {
            const el = document.getElementById('reportDetails');
            const icon = document.getElementById('reportToggleIcon');
            if (el.classList.contains('open')) {
                el.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
            } else {
                el.classList.add('open');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        // --- Feature 2: Click Interaction ---
        function highlightStudent(name) {
            // Remove all existing highlights
            document.querySelectorAll('.student-tag').forEach(el => {
                el.classList.remove('highlight-self', 'highlight-friend', 'highlight-enemy', 'dimmed');
            });

            // If clicking empty space (handled by global listener usually, but for now simple toggle logic)
            // We just implement "Active" state.
            
            const myGid = processedGroupIdMap.get(name);
            if (myGid === undefined) return; // Error or not found

            // 1. Dim everyone first
            document.querySelectorAll('.student-tag').forEach(el => el.classList.add('dimmed'));

            // 2. Highlight Self
            const selfTag = document.querySelector(`.student-tag[data-name="${name}"]`);
            if (selfTag) {
                selfTag.classList.remove('dimmed');
                selfTag.classList.add('highlight-self');
            }

            // 3. Highlight Friends (Same Group)
            const friends = groupMembers.get(myGid) || [];
            friends.forEach(fName => {
                if (fName === name) return;
                const tag = document.querySelector(`.student-tag[data-name="${fName}"]`);
                if (tag) {
                    tag.classList.remove('dimmed');
                    tag.classList.add('highlight-friend');
                }
            });

            // 4. Highlight Enemies (Adjacent Groups)
            if (groupAdjacency.has(myGid)) {
                const enemyGids = groupAdjacency.get(myGid);
                enemyGids.forEach(eGid => {
                    const enemies = groupMembers.get(eGid);
                    enemies.forEach(eName => {
                        const tag = document.querySelector(`.student-tag[data-name="${eName}"]`);
                        if (tag) {
                            tag.classList.remove('dimmed');
                            tag.classList.add('highlight-enemy');
                        }
                    });
                });
            }
        }

        // Clear highlights when clicking background
        document.addEventListener('click', function(e) {
            if (!e.target.classList.contains('student-tag')) {
                document.querySelectorAll('.student-tag').forEach(el => {
                    el.classList.remove('highlight-self', 'highlight-friend', 'highlight-enemy', 'dimmed');
                });
            }
        });

        // --- Feature 3: Search ---
        function searchStudent() {
            const query = document.getElementById('studentSearch').value.trim().toLowerCase();
            const cards = document.querySelectorAll('.class-card');
            
            // If empty, reset
            if (!query) {
                cards.forEach(card => card.style.opacity = '1');
                document.querySelectorAll('.student-tag').forEach(t => {
                    t.classList.remove('highlight-self', 'dimmed');
                });
                return;
            }

            // Highlight Logic
            let found = false;
            cards.forEach(card => {
                const tags = card.querySelectorAll('.student-tag');
                let cardHasMatch = false;
                
                tags.forEach(tag => {
                    if (tag.innerText.toLowerCase().includes(query)) {
                        tag.classList.add('highlight-self');
                        tag.classList.remove('dimmed');
                        cardHasMatch = true;
                        found = true;
                    } else {
                        tag.classList.remove('highlight-self');
                        tag.classList.add('dimmed');
                    }
                });

                if (cardHasMatch) {
                    card.style.opacity = '1';
                } else {
                    card.style.opacity = '0.4';
                }
            });
        }

        function copyResults() {
            const grid = document.getElementById('resultGrid');
            if(grid.children.length === 0 || grid.innerText.includes('ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³ ')) {
                alert('ë³µì‚¬í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            let text = "í•™ê¸‰ í¸ì„± ê²°ê³¼\n================\n";
            const cards = grid.querySelectorAll('.class-card');
            cards.forEach(card => {
                const title = card.querySelector('h3').innerText;
                const count = card.querySelector('span.rounded-full').innerText;
                const students = Array.from(card.querySelectorAll('.student-tag')).map(s => s.innerText).join(', ');
                text += `[${title}] (${count}) : ${students}\n`;
            });
            navigator.clipboard.writeText(text).then(() => {
                alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
        }
    </script>
</body>
</html>
